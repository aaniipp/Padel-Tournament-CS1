<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<title>Padel Tournament Ultimate</title>

<style>
* {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display",sans-serif;
    background:linear-gradient(180deg,#0f2027,#203a43,#2c5364);
    color:white;
    text-align:center;
    min-height: 100vh;
    overflow-x: hidden;
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
}

.container{
    max-width:700px;
    margin:auto;
    padding:20px;
    padding-bottom:120px;
}

/* ===== TABS ===== */
.tabs{
    display:flex;
    justify-content:center;
    gap:12px;
    margin-bottom:20px;
}

.tab-btn{
    padding:14px 24px;
    border:none;
    border-radius:16px;
    cursor:pointer;
    background:rgba(255,255,255,0.15);
    color:white;
    font-size:16px;
    font-weight:600;
    transition:all 0.3s ease;
    min-height:52px;
    min-width:100px;
}

.tab-btn:active{
    transform:scale(0.95);
}

.active-tab{
    background:linear-gradient(135deg,#00e676,#00c853);
    color:black;
    box-shadow:0 4px 15px rgba(0,230,118,0.4);
}

/* ===== MODE BUTTONS ===== */
.mode-buttons{
    display:flex;
    gap:15px;
    justify-content:center;
    margin-bottom:20px;
}

.mode-btn{
    flex:1;
    padding:18px 20px;
    border:none;
    border-radius:20px;
    cursor:pointer;
    font-size:16px;
    font-weight:700;
    transition:all 0.3s ease;
    min-height:64px;
}

.americano-btn{
    background:rgba(255,152,0,0.2);
    color:#ff9800;
    border:2px solid #ff9800;
}

.tennis-btn{
    background:rgba(156,39,176,0.2);
    color:#9c27b0;
    border:2px solid #9c27b0;
}

.americano-btn.active{
    background:linear-gradient(135deg,#ff9800,#ffa726);
    color:white;
    box-shadow:0 6px 20px rgba(255,152,0,0.5);
    transform:scale(1.02);
}

.tennis-btn.active{
    background:linear-gradient(135deg,#9c27b0,#ab47bc);
    color:white;
    box-shadow:0 6px 20px rgba(156,39,176,0.5);
    transform:scale(1.02);
}

.mode-btn:active{
    transform:scale(0.97);
}

/* ===== ROUND & MODE LABEL ===== */
.round-label{
    font-size:18px;
    font-weight:600;
    margin:15px 0 5px 0;
    color:#00e676;
}

.mode-label{
    font-size:14px;
    opacity:0.8;
    margin-bottom:20px;
}

/* ===== TEAMS ===== */
.teams{
    display:flex;
    gap:20px;
    margin-top:25px;
}

.team{
    flex:1;
    background:rgba(255,255,255,0.1);
    backdrop-filter:blur(15px);
    border-radius:24px;
    padding:20px 15px;
    border:2px solid rgba(255,255,255,0.1);
    transition:all 0.3s ease;
}

.team-name{
    font-size:18px;
    font-weight:700;
    margin-bottom:15px;
    min-height:44px;
    display:flex;
    align-items:center;
    justify-content:center;
}

.score-display{
    font-size:72px;
    font-weight:800;
    margin:15px 0;
    line-height:1;
    transition:all 0.3s ease;
    text-shadow:0 4px 20px rgba(0,0,0,0.3);
}

.score-display.pulse{
    animation:scorePulse 0.4s ease;
}

@keyframes scorePulse{
    0%,100%{transform:scale(1);}
    50%{transform:scale(1.15);}
}

.games-display{
    font-size:16px;
    opacity:0.8;
    margin-bottom:20px;
    min-height:24px;
}

/* ===== LARGE TAP TARGETS ===== */
.score-controls{
    display:flex;
    gap:12px;
    justify-content:center;
    flex-wrap:wrap;
}

.score-btn{
    padding:18px 28px;
    border:none;
    border-radius:18px;
    cursor:pointer;
    font-size:20px;
    font-weight:700;
    transition:all 0.2s ease;
    min-width:100px;
    min-height:64px;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
}

.score-btn:active{
    transform:scale(0.92);
}

.score-btn.add{
    background:linear-gradient(135deg,#00e676,#00c853);
    color:black;
    box-shadow:0 4px 15px rgba(0,230,118,0.4);
}

.score-btn.subtract{
    background:linear-gradient(135deg,#ff5252,#ff1744);
    color:white;
    box-shadow:0 4px 15px rgba(255,82,82,0.4);
}

.score-btn:disabled{
    opacity:0.3;
    cursor:not-allowed;
    transform:none;
}

/* ===== ACTION BUTTONS ===== */
.action-buttons{
    display:flex;
    gap:15px;
    justify-content:center;
    margin-top:30px;
    flex-wrap:wrap;
}

.action-btn{
    padding:16px 28px;
    border:none;
    border-radius:16px;
    cursor:pointer;
    font-size:16px;
    font-weight:600;
    transition:all 0.3s ease;
    min-height:56px;
    min-width:120px;
}

.action-btn:active{
    transform:scale(0.95);
}

.finish-btn{
    background:linear-gradient(135deg,#00e676,#00c853);
    color:black;
    box-shadow:0 4px 15px rgba(0,230,118,0.4);
}

.standings-btn{
    background:rgba(255,255,255,0.15);
    color:white;
    border:2px solid rgba(255,255,255,0.3);
}

.reset-btn{
    background:rgba(255,82,82,0.2);
    color:#ff5252;
    border:2px solid #ff5252;
}

/* ===== UNDO BUTTON ===== */
.undo-container{
    position:fixed;
    bottom:30px;
    left:50%;
    transform:translateX(-50%);
    z-index:1000;
    display:none;
    padding:0 10px;
    width:100%;
    max-width:400px;
}

.undo-btn{
    padding:16px 32px;
    border:none;
    border-radius:50px;
    background:linear-gradient(135deg,#ff9800,#ffa726);
    color:black;
    font-size:16px;
    font-weight:700;
    cursor:pointer;
    box-shadow:0 6px 25px rgba(255,152,0,0.5);
    min-height:60px;
    min-width:180px;
    max-width:100%;
    transition:all 0.3s ease;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    white-space:nowrap;
    margin:0 auto;
}

.undo-btn:active{
    transform:scale(0.95);
}

.undo-btn.visible{
    display:flex;
    animation:slideUp 0.3s ease;
}

@keyframes slideUp{
    from{opacity:0;transform:translateX(-50%) translateY(20px);}
    to{opacity:1;transform:translateX(-50%) translateY(0);}
}

/* ===== CONFIRMATION MODAL ===== */
.modal-overlay{
    position:fixed;
    top:0;
    left:0;
    right:0;
    bottom:0;
    background:rgba(0,0,0,0.8);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:2000;
    padding:20px;
}

.modal-overlay.visible{
    display:flex;
    animation:fadeIn 0.2s ease;
}

@keyframes fadeIn{
    from{opacity:0;}
    to{opacity:1;}
}

.modal-content{
    background:linear-gradient(180deg,#1a2a3a,#2a3a4a);
    border-radius:24px;
    padding:30px;
    max-width:400px;
    width:100%;
    border:2px solid rgba(255,255,255,0.1);
    animation:modalSlide 0.3s ease;
}

@keyframes modalSlide{
    from{opacity:0;transform:scale(0.9) translateY(20px);}
    to{opacity:1;transform:scale(1) translateY(0);}
}

.modal-title{
    font-size:24px;
    font-weight:700;
    margin-bottom:15px;
    color:#ff5252;
}

.modal-message{
    font-size:16px;
    margin-bottom:25px;
    opacity:0.9;
    line-height:1.5;
}

.modal-buttons{
    display:flex;
    gap:15px;
    justify-content:center;
}

.modal-btn{
    padding:16px 32px;
    border:none;
    border-radius:14px;
    cursor:pointer;
    font-size:16px;
    font-weight:600;
    min-height:56px;
    min-width:120px;
    transition:all 0.2s ease;
}

.modal-btn:active{
    transform:scale(0.95);
}

.modal-confirm{
    background:linear-gradient(135deg,#ff5252,#ff1744);
    color:white;
}

.modal-cancel{
    background:rgba(255,255,255,0.15);
    color:white;
}

/* ===== RANKING TABLE ===== */
table{
    width:100%;
    margin-top:20px;
    border-collapse:collapse;
    background:rgba(255,255,255,0.05);
    border-radius:16px;
    overflow:hidden;
}

th, td{
    padding:14px 10px;
    border-bottom:1px solid rgba(255,255,255,0.1);
    text-align:center;
}

th{
    background:rgba(255,255,255,0.1);
    font-weight:700;
    font-size:14px;
    text-transform:uppercase;
    letter-spacing:1px;
}

tr:last-child td{
    border-bottom:none;
}

.gold{color:#ffd700;font-weight:700;text-shadow:0 0 10px rgba(255,215,0,0.5);}
.silver{color:#c0c0c0;font-weight:700;}
.bronze{color:#cd7f32;font-weight:700;}
.fourth{color:#a0a0a0;font-weight:700;}

/* ===== VISUAL FEEDBACK ===== */
.feedback-toast{
    position:fixed;
    top:100px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(0,230,118,0.95);
    color:black;
    padding:16px 32px;
    border-radius:50px;
    font-weight:700;
    font-size:18px;
    z-index:3000;
    box-shadow:0 6px 25px rgba(0,230,118,0.5);
    display:none;
    animation:toastSlide 0.3s ease;
}

@keyframes toastSlide{
    from{opacity:0;transform:translateX(-50%) translateY(-20px);}
    to{opacity:1;transform:translateX(-50%) translateY(0);}
}

/* ===== MOBILE RESPONSIVE ===== */
@media (max-width: 600px){
    .container{
        padding:12px;
        padding-bottom:160px;
    }

    h1{
        font-size:24px;
        margin-bottom:10px;
    }

    .tabs{
        gap:8px;
        margin-bottom:15px;
    }

    .tab-btn{
        padding:12px 14px;
        font-size:13px;
        min-height:48px;
        min-width:70px;
        border-radius:12px;
    }

    .mode-buttons{
        gap:10px;
        margin-bottom:15px;
    }

    .mode-btn{
        padding:14px 12px;
        font-size:13px;
        min-height:60px;
        border-radius:16px;
    }

    .mode-btn small{
        font-size:11px;
    }

    .round-label{
        font-size:16px;
        margin:10px 0 3px 0;
    }

    .mode-label{
        font-size:12px;
        margin-bottom:15px;
    }

    .teams{
        flex-direction:column;
        gap:12px;
    }

    .team{
        padding:15px 12px;
        border-radius:18px;
    }

    .team-name{
        font-size:15px;
        min-height:40px;
    }

    .score-display{
        font-size:56px;
        margin:12px 0;
    }

    .games-display{
        font-size:14px;
        margin-bottom:15px;
    }

    .score-controls{
        gap:8px;
    }

    .score-btn{
        padding:14px 20px;
        font-size:16px;
        min-width:85px;
        min-height:58px;
        border-radius:14px;
    }

    .action-buttons{
        gap:10px;
        margin-top:20px;
    }

    .action-btn{
        padding:12px 16px;
        font-size:13px;
        min-height:50px;
        min-width:90px;
        border-radius:14px;
    }

    table{
        font-size:11px;
        margin-top:15px;
    }

    th, td{
        padding:8px 4px;
    }

    th{
        font-size:10px;
    }

    .modal-content{
        padding:18px;
        margin:10px;
        border-radius:18px;
    }

    .modal-title{
        font-size:18px;
        margin-bottom:12px;
    }

    .modal-message{
        font-size:13px;
        margin-bottom:20px;
    }

    .modal-buttons{
        gap:10px;
    }

    .modal-btn{
        padding:14px 24px;
        font-size:14px;
        min-height:52px;
        min-width:100px;
        border-radius:12px;
    }

    .feedback-toast{
        font-size:16px;
        padding:14px 24px;
        top:80px;
    }

    .undo-container{
        bottom:20px;
        padding:0 15px;
    }

    .undo-btn{
        padding:14px 28px;
        font-size:15px;
        min-height:56px;
        min-width:160px;
    }
}

/* ===== SMALL MOBILE (iPhone SE, etc.) ===== */
@media (max-width: 375px){
    .container{
        padding:10px;
        padding-bottom:150px;
    }

    h1{
        font-size:20px;
    }

    .tab-btn{
        padding:10px 12px;
        font-size:12px;
        min-height:44px;
        min-width:60px;
    }

    .mode-btn{
        padding:12px 10px;
        font-size:12px;
        min-height:56px;
    }

    .mode-btn small{
        font-size:10px;
    }

    .score-display{
        font-size:48px;
    }

    .score-btn{
        padding:12px 16px;
        font-size:15px;
        min-width:75px;
        min-height:54px;
    }

    .action-btn{
        padding:10px 14px;
        font-size:12px;
        min-height:48px;
        min-width:80px;
    }

    table{
        font-size:10px;
    }

    th, td{
        padding:6px 3px;
    }

    .undo-container{
        bottom:15px;
        padding:0 10px;
    }

    .undo-btn{
        padding:12px 24px;
        font-size:14px;
        min-height:52px;
        min-width:140px;
    }

    .feedback-toast{
        font-size:14px;
        padding:12px 20px;
        top:70px;
    }
}

/* ===== SMALL MOBILE (iPhone SE, etc.) ===== */
@media (max-width: 375px){
    .container{
        padding:10px;
        padding-bottom:150px;
    }

    h1{
        font-size:20px;
    }

    .tab-btn{
        padding:10px 12px;
        font-size:12px;
        min-height:44px;
        min-width:60px;
    }

    .mode-btn{
        padding:12px 10px;
        font-size:12px;
        min-height:56px;
    }

    .mode-btn small{
        font-size:10px;
    }

    .score-display{
        font-size:48px;
    }

    .score-btn{
        padding:12px 16px;
        font-size:15px;
        min-width:75px;
        min-height:54px;
    }

    .action-btn{
        padding:10px 14px;
        font-size:12px;
        min-height:48px;
        min-width:80px;
    }

    table{
        font-size:10px;
    }

    th, td{
        padding:6px 3px;
    }
}

/* ===== TOUCH OPTIMIZATION ===== */
@media (hover: none) and (pointer: coarse){
    .score-btn, .action-btn, .mode-btn, .tab-btn, .undo-btn, .modal-btn{
        min-height:56px;
        min-width:56px;
        touch-action: manipulation;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
    }

    .score-btn{
        min-height:68px;
        min-width:110px;
    }

    .undo-btn{
        min-height:72px;
    }

    * {
        -webkit-tap-highlight-color: rgba(0, 230, 118, 0.3);
    }
}

/* ===== LANDSCAPE MOBILE ===== */
@media (max-width: 900px) and (max-height: 500px) and (orientation: landscape){
    .container{
        padding:8px;
        padding-bottom:100px;
    }

    h1{
        font-size:18px;
        margin-bottom:5px;
    }

    .tabs{
        margin-bottom:8px;
    }

    .tab-btn{
        padding:8px 12px;
        font-size:12px;
        min-height:40px;
    }

    .mode-buttons{
        margin-bottom:8px;
    }

    .mode-btn{
        padding:10px 12px;
        font-size:12px;
        min-height:48px;
    }

    .mode-btn small{
        display:none;
    }

    .round-label{
        font-size:14px;
        margin:5px 0;
    }

    .mode-label{
        font-size:11px;
        margin-bottom:8px;
    }

    .teams{
        gap:10px;
    }

    .team{
        padding:10px 8px;
    }

    .team-name{
        font-size:13px;
        min-height:30px;
    }

    .score-display{
        font-size:36px;
        margin:8px 0;
    }

    .games-display{
        font-size:12px;
        margin-bottom:8px;
    }

    .score-btn{
        padding:10px 16px;
        font-size:14px;
        min-width:70px;
        min-height:44px;
    }

    .action-buttons{
        margin-top:10px;
    }

    .action-btn{
        padding:8px 12px;
        font-size:11px;
        min-height:40px;
        min-width:70px;
    }

    .undo-container{
        bottom:10px;
        padding:0 10px;
    }

    .undo-btn{
        padding:10px 20px;
        font-size:13px;
        min-height:44px;
        min-width:140px;
    }

    .modal-content{
        padding:15px;
        max-width:350px;
    }

    .modal-title{
        font-size:16px;
    }

    .modal-message{
        font-size:12px;
    }
}

/* ===== ACCESSIBILITY ===== */
button:focus{
    outline:3px solid #00e676;
    outline-offset:2px;
}

button:focus:not(:focus-visible){
    outline:none;
}

button:focus-visible{
    outline:3px solid #00e676;
    outline-offset:2px;
}
</style>
</head>

<body>

<div class="container">

<h1>üèÜ PADEL TOURNAMENT</h1>

<div class="tabs">
    <button id="tabMatch" class="tab-btn active-tab" onclick="showTab('match')">Match</button>
    <button id="tabRanking" class="tab-btn" onclick="showTab('ranking')">Ranking</button>
    <button id="tabHistory" class="tab-btn" onclick="showTab('history')">History</button>
</div>

<div id="matchTab">

<div class="mode-buttons">
    <button id="btnAmericano" class="mode-btn americano-btn active" onclick="setMode('americano')">üèÜ Americano<br><small>Points System</small></button>
    <button id="btnTennis" class="mode-btn tennis-btn" onclick="setMode('tennis')">üéæ Tennis<br><small>Games System</small></button>
</div>

<h3 id="roundLabel" class="round-label"></h3>
<h4 id="modeLabel" class="mode-label"></h4>

<div class="teams">
    <div class="team">
        <h3 id="teamAName" class="team-name"></h3>
        <div class="score-display" id="scoreA">0</div>
        <div class="games-display" id="gamesA"></div>
        <div class="score-controls">
            <button class="score-btn add" onclick="addPoint('A')" aria-label="Add point to Team A">
                <span>‚ûï</span> Point
            </button>
            <button class="score-btn subtract" onclick="minusPoint('A')" aria-label="Subtract point from Team A">
                <span>‚ûñ</span> Point
            </button>
        </div>
    </div>

    <div class="team">
        <h3 id="teamBName" class="team-name"></h3>
        <div class="score-display" id="scoreB">0</div>
        <div class="games-display" id="gamesB"></div>
        <div class="score-controls">
            <button class="score-btn add" onclick="addPoint('B')" aria-label="Add point to Team B">
                <span>‚ûï</span> Point
            </button>
            <button class="score-btn subtract" onclick="minusPoint('B')" aria-label="Subtract point from Team B">
                <span>‚ûñ</span> Point
            </button>
        </div>
    </div>
</div>

<div class="action-buttons">
    <button class="action-btn finish-btn" onclick="confirmFinishMatch()">‚úÖ Finish Match</button>
    <button class="action-btn standings-btn" onclick="finishTournament()">üìä Standings</button>
    <button class="action-btn reset-btn" onclick="confirmResetTournament()">üîÑ Reset</button>
</div>

</div>

<div id="rankingTab" style="display:none;">
<h2>üèÜ Ranking Table</h2>

<div class="tabs">
    <button id="tabAmericano" class="tab-btn active-tab" onclick="showRankingTab('americano')">Americano</button>
    <button id="tabTennis" class="tab-btn" onclick="showRankingTab('tennis')">Tennis</button>
</div>

<div id="americanoRanking">
<h3>Americano Ranking</h3>
<p style="font-size:13px;opacity:0.7;margin:8px 0;">Points = Total points scored (max 21 per match)</p>
<table>
<thead>
<tr>
<th>Rank</th>
<th>Name</th>
<th>Win</th>
<th>Point</th>
<th>Conceded</th>
<th>GAP</th>
</tr>
</thead>
<tbody id="americanoRankingBody"></tbody>
</table>
</div>

<div id="tennisRanking" style="display:none;">
<h3>Tennis Ranking</h3>
<p style="font-size:13px;opacity:0.7;margin:8px 0;">Games = Total games won (e.g., 2-1 = 2 games for winner)</p>
<table>
<thead>
<tr>
<th>Rank</th>
<th>Name</th>
<th>Win</th>
<th>Games</th>
<th>Conceded</th>
<th>GAP</th>
</tr>
</thead>
<tbody id="tennisRankingBody"></tbody>
</table>
</div>

</div>

<div id="historyTab" style="display:none;">
<h2>üìú Match History</h2>

<div class="tabs">
    <button id="tabHistoryAmericano" class="tab-btn active-tab" onclick="showHistoryTab('americano')">Americano</button>
    <button id="tabHistoryTennis" class="tab-btn" onclick="showHistoryTab('tennis')">Tennis</button>
</div>

<div id="americanoHistory">
<h3>Americano Matches</h3>
<table>
<thead>
<tr>
<th>Round</th>
<th>Team A</th>
<th>Score</th>
<th>Team B</th>
<th>Winner</th>
</tr>
</thead>
<tbody id="americanoHistoryBody"></tbody>
</table>
</div>

<div id="tennisHistory" style="display:none;">
<h3>Tennis Matches</h3>
<table>
<thead>
<tr>
<th>Round</th>
<th>Team A</th>
<th>Games Won</th>
<th>Team B</th>
<th>Winner</th>
</tr>
</thead>
<tbody id="tennisHistoryBody"></tbody>
</table>
</div>

</div>

</div>

<!-- UNDO BUTTON -->
<div class="undo-container">
    <button class="undo-btn" id="undoBtn" onclick="undoLastAction()">
        <span>‚Ü©Ô∏è</span> Undo Last Action
    </button>
</div>

<!-- CONFIRMATION MODAL -->
<div class="modal-overlay" id="confirmModal">
    <div class="modal-content">
        <h3 class="modal-title" id="modalTitle">Confirm Action</h3>
        <p class="modal-message" id="modalMessage">Are you sure you want to proceed?</p>
        <div class="modal-buttons">
            <button class="modal-btn modal-cancel" onclick="closeModal()">Cancel</button>
            <button class="modal-btn modal-confirm" id="modalConfirmBtn">Confirm</button>
        </div>
    </div>
</div>

<!-- FEEDBACK TOAST -->
<div class="feedback-toast" id="feedbackToast"></div>

<script>

// ===== DATA =====

let defaultPlayers = {
    "Aria": {americano:{win:0, point:0, conceded:0}, tennis:{win:0, point:0, conceded:0}},
    "Bryan": {americano:{win:0, point:0, conceded:0}, tennis:{win:0, point:0, conceded:0}},
    "Hanip": {americano:{win:0, point:0, conceded:0}, tennis:{win:0, point:0, conceded:0}},
    "Lutpi": {americano:{win:0, point:0, conceded:0}, tennis:{win:0, point:0, conceded:0}}
};

let players = JSON.parse(localStorage.getItem("padelPlayers")) || defaultPlayers;
let americanoRound = parseInt(localStorage.getItem("padelAmericanoRound")) || 0;
let tennisRound = parseInt(localStorage.getItem("padelTennisRound")) || 0;
let currentRound = americanoRound;

let rounds = [
    {A:["Aria","Bryan"], B:["Hanip","Lutpi"]},
    {A:["Aria","Hanip"], B:["Bryan","Lutpi"]},
    {A:["Aria","Lutpi"], B:["Bryan","Hanip"]}
];

let mode = localStorage.getItem("padelCurrentMode") || "americano";
let scoreA = 0;
let scoreB = 0;

// Tennis variables
let tennisPoints = ["0","15","30","40"];
let tennisA = 0;
let tennisB = 0;
let gamesA = 0;
let gamesB = 0;

// Match state for each mode
let americanoState = JSON.parse(localStorage.getItem("padelAmericanoState")) || {scoreA:0, scoreB:0};
let tennisState = JSON.parse(localStorage.getItem("padelTennisState")) || {tennisA:0, tennisB:0, gamesA:0, gamesB:0};

// Match history
let matchHistory = JSON.parse(localStorage.getItem("padelMatchHistory")) || [];

// Action history for undo functionality
let actionHistory = [];
const MAX_HISTORY = 10;

// ===== SAVE =====

function saveData(){
    localStorage.setItem("padelPlayers", JSON.stringify(players));
    localStorage.setItem("padelAmericanoRound", americanoRound);
    localStorage.setItem("padelTennisRound", tennisRound);
    localStorage.setItem("padelMatchHistory", JSON.stringify(matchHistory));

    // Save current state for each mode
    americanoState = {scoreA: scoreA, scoreB: scoreB};
    tennisState = {tennisA: tennisA, tennisB: tennisB, gamesA: gamesA, gamesB: gamesB};
    localStorage.setItem("padelAmericanoState", JSON.stringify(americanoState));
    localStorage.setItem("padelTennisState", JSON.stringify(tennisState));

    // Save current mode
    localStorage.setItem("padelCurrentMode", mode);
}

// ===== ACTION HISTORY =====

function addToHistory(action){
    actionHistory.push({
        action: action,
        timestamp: Date.now(),
        mode: mode,
        state: {
            scoreA: scoreA,
            scoreB: scoreB,
            tennisA: tennisA,
            tennisB: tennisB,
            gamesA: gamesA,
            gamesB: gamesB
        }
    });
    
    // Keep only last MAX_HISTORY actions
    if(actionHistory.length > MAX_HISTORY){
        actionHistory.shift();
    }
    
    updateUndoButton();
}

function undoLastAction(){
    if(actionHistory.length === 0) return;
    
    const lastAction = actionHistory.pop();
    const prevState = lastAction.state;
    
    // Restore previous state
    scoreA = prevState.scoreA;
    scoreB = prevState.scoreB;
    tennisA = prevState.tennisA;
    tennisB = prevState.tennisB;
    gamesA = prevState.gamesA;
    gamesB = prevState.gamesB;
    
    // Update UI
    updateScoreUI();
    saveData();
    updateUndoButton();
    
    // Show feedback
    showFeedback("Action undone! ‚Ü©Ô∏è");
    
    // Haptic feedback if available
    if(navigator.vibrate){
        navigator.vibrate(50);
    }
}

function updateUndoButton(){
    const undoBtn = document.getElementById("undoBtn");
    if(actionHistory.length > 0){
        undoBtn.classList.add("visible");
    } else {
        undoBtn.classList.remove("visible");
    }
}

// ===== VISUAL FEEDBACK =====

function showFeedback(message){
    const toast = document.getElementById("feedbackToast");
    toast.textContent = message;
    toast.style.display = "block";
    
    // Haptic feedback
    if(navigator.vibrate){
        navigator.vibrate(30);
    }
    
    setTimeout(() => {
        toast.style.display = "none";
    }, 1500);
}

function animateScore(elementId){
    const element = document.getElementById(elementId);
    element.classList.remove("pulse");
    void element.offsetWidth; // Trigger reflow
    element.classList.add("pulse");
}

// ===== MODAL =====

let pendingAction = null;

function showConfirmModal(title, message, confirmCallback){
    document.getElementById("modalTitle").textContent = title;
    document.getElementById("modalMessage").textContent = message;
    
    const confirmBtn = document.getElementById("modalConfirmBtn");
    confirmBtn.onclick = () => {
        closeModal();
        confirmCallback();
    };
    
    document.getElementById("confirmModal").classList.add("visible");
}

function closeModal(){
    document.getElementById("confirmModal").classList.remove("visible");
    pendingAction = null;
}

function confirmFinishMatch(){
    showConfirmModal(
        "Finish Match?",
        "This will record the current scores and move to the next round. This action cannot be undone.",
        finishMatch
    );
}

function confirmResetTournament(){
    showConfirmModal(
        "Reset Tournament?",
        "This will delete all match history, rankings, and scores. This action cannot be undone!",
        resetTournament
    );
}

// ===== TAB =====

function showTab(tab){
    document.getElementById("matchTab").style.display = tab==="match"?"block":"none";
    document.getElementById("rankingTab").style.display = tab==="ranking"?"block":"none";
    document.getElementById("historyTab").style.display = tab==="history"?"block":"none";

    document.getElementById("tabMatch").classList.toggle("active-tab", tab==="match");
    document.getElementById("tabRanking").classList.toggle("active-tab", tab==="ranking");
    document.getElementById("tabHistory").classList.toggle("active-tab", tab==="history");

    if(tab==="match"){
        // Restore score UI and round when returning to match tab
        updateScoreUI();
        loadRound();
    } else if(tab==="ranking"){
        updateRanking();
    } else if(tab==="history"){
        updateHistory();
    }
}

function showRankingTab(modeTab){
    document.getElementById("americanoRanking").style.display = modeTab==="americano"?"block":"none";
    document.getElementById("tennisRanking").style.display = modeTab==="tennis"?"block":"none";

    document.getElementById("tabAmericano").classList.toggle("active-tab", modeTab==="americano");
    document.getElementById("tabTennis").classList.toggle("active-tab", modeTab==="tennis");

    updateRanking();
}

function showHistoryTab(modeTab){
    document.getElementById("americanoHistory").style.display = modeTab==="americano"?"block":"none";
    document.getElementById("tennisHistory").style.display = modeTab==="tennis"?"block":"none";

    document.getElementById("tabHistoryAmericano").classList.toggle("active-tab", modeTab==="americano");
    document.getElementById("tabHistoryTennis").classList.toggle("active-tab", modeTab==="tennis");

    updateHistory();
}

// ===== MATCH =====

function loadRound(){
    let r = rounds[currentRound];
    document.getElementById("teamAName").innerText = r.A.join(" & ");
    document.getElementById("teamBName").innerText = r.B.join(" & ");
    document.getElementById("roundLabel").innerText = "Round " + (currentRound+1) + " (" + (mode==="americano"?"Americano":"Tennis") + ")";
}

function setMode(m){
    // Save current state before switching
    if(mode==="americano"){
        americanoState = {scoreA: scoreA, scoreB: scoreB};
    } else {
        tennisState = {tennisA: tennisA, tennisB: tennisB, gamesA: gamesA, gamesB: gamesB};
    }

    mode = m;

    // Restore state for the new mode
    if(m==="americano"){
        scoreA = americanoState.scoreA;
        scoreB = americanoState.scoreB;
        tennisA = tennisB = 0;
        gamesA = gamesB = 0;
        currentRound = americanoRound;
    } else {
        tennisA = tennisState.tennisA;
        tennisB = tennisState.tennisB;
        gamesA = tennisState.gamesA;
        gamesB = tennisState.gamesB;
        scoreA = scoreB = 0;
        currentRound = tennisRound;
    }

    updateScoreUI();
    loadRound();
    document.getElementById("modeLabel").innerText =
        m==="americano" ? "Mode: Americano (Total Points: 21)" : "Mode: Tennis (Best of 3 Games)";

    // Toggle active class on mode buttons
    document.getElementById("btnAmericano").classList.toggle("active", m==="americano");
    document.getElementById("btnTennis").classList.toggle("active", m==="tennis");

    // Clear action history when switching modes
    actionHistory = [];
    updateUndoButton();

    // Save the restored state
    saveData();
    
    // Show feedback
    showFeedback(m==="americano" ? "Americano Mode üèÜ" : "Tennis Mode üéæ");
}

function updateScoreUI(){

    if(mode==="americano"){
        document.getElementById("scoreA").innerText = scoreA;
        document.getElementById("scoreB").innerText = scoreB;
        document.getElementById("gamesA").innerText = "";
        document.getElementById("gamesB").innerText = "";
        return;
    }

    let displayA, displayB;

    if(tennisA >=3 && tennisB >=3){
        if(tennisA === tennisB){
            displayA = displayB = "Deuce";
        }
        else if(tennisA > tennisB){
            displayA = "Adv";
            displayB = "40";
        }
        else{
            displayA = "40";
            displayB = "Adv";
        }
    } else {
        displayA = tennisPoints[tennisA] || "0";
        displayB = tennisPoints[tennisB] || "0";
    }

    document.getElementById("scoreA").innerText = displayA;
    document.getElementById("scoreB").innerText = displayB;

    document.getElementById("gamesA").innerText = "Games: " + gamesA;
    document.getElementById("gamesB").innerText = "Games: " + gamesB;
}

function addPoint(team){
    // Add to history before making changes
    addToHistory("addPoint");

    // ===== AMERICANO =====
    if(mode==="americano"){
        let total = scoreA + scoreB;
        if(total >= 21) return;

        if(team==="A") scoreA++;
        else scoreB++;

        // Animate score
        animateScore(team==="A"?"scoreA":"scoreB");

        if(scoreA + scoreB === 21){
            updateScoreUI();
            setTimeout(()=>finishMatch(),500);
            return;
        }

        updateScoreUI();
        saveData();
        showFeedback(team==="A"?"Team A +1 ‚ûï" : "Team B +1 ‚ûï");
        return;
    }

    // ===== TENNIS =====
    if(team==="A") tennisA++;
    else tennisB++;

    // Animate score
    animateScore(team==="A"?"scoreA":"scoreB");

    if(tennisA >=3 && tennisB >=3){
        if(Math.abs(tennisA - tennisB) >=2){
            if(tennisA > tennisB) gamesA++;
            else gamesB++;

            tennisA = tennisB = 0;

            // Check for best of 3 winner
            if(gamesA === 2 || gamesB === 2){
                updateScoreUI();
                setTimeout(()=>finishMatch(),500);
                return;
            }
        }
    }
    else if(tennisA >=4){
        gamesA++;
        tennisA = tennisB = 0;

        // Check for best of 3 winner
        if(gamesA === 2 || gamesB === 2){
            updateScoreUI();
            setTimeout(()=>finishMatch(),500);
            return;
        }
    }
    else if(tennisB >=4){
        gamesB++;
        tennisA = tennisB = 0;

        // Check for best of 3 winner
        if(gamesA === 2 || gamesB === 2){
            updateScoreUI();
            setTimeout(()=>finishMatch(),500);
            return;
        }
    }

    updateScoreUI();
    saveData();
    showFeedback(team==="A"?"Team A +1 ‚ûï" : "Team B +1 ‚ûï");
}

function minusPoint(team){
    // Add to history before making changes
    addToHistory("minusPoint");

    if(mode==="americano"){
        if(team==="A" && scoreA>0) scoreA--;
        if(team==="B" && scoreB>0) scoreB--;
    } else {
        if(team==="A" && tennisA>0) tennisA--;
        if(team==="B" && tennisB>0) tennisB--;
    }
    
    updateScoreUI();
    saveData();
    showFeedback(team==="A"?"Team A -1 ‚ûñ" : "Team B -1 ‚ûñ");
}

function finishMatch(){

    let finalA = mode==="americano" ? scoreA : gamesA;
    let finalB = mode==="americano" ? scoreB : gamesB;

    let r = rounds[currentRound];

    // Save match history
    let matchRecord = {
        round: currentRound + 1,
        mode: mode,
        teamA: r.A.join(" & "),
        teamB: r.B.join(" & "),
        scoreA: finalA,
        scoreB: finalB,
        winner: finalA > finalB ? r.A.join(" & ") : (finalB > finalA ? r.B.join(" & ") : "Draw"),
        timestamp: new Date().toISOString()
    };
    matchHistory.push(matchRecord);

    if(mode==="americano"){
        // Americano: total points scored
        r.A.forEach(p=>{
            players[p].americano.point += finalA;
            players[p].americano.conceded += finalB;
        });

        r.B.forEach(p=>{
            players[p].americano.point += finalB;
            players[p].americano.conceded += finalA;
        });

        if(finalA > finalB){
            r.A.forEach(p=>players[p].americano.win++);
        } else if(finalB > finalA){
            r.B.forEach(p=>players[p].americano.win++);
        }
    } else {
        // Tennis: track games won (e.g., 2-1 = 2 games for winner, 1 game for loser)
        r.A.forEach(p=>{
            players[p].tennis.point += gamesA;
            players[p].tennis.conceded += gamesB;
        });

        r.B.forEach(p=>{
            players[p].tennis.point += gamesB;
            players[p].tennis.conceded += gamesA;
        });

        if(gamesA > gamesB){
            r.A.forEach(p=>players[p].tennis.win++);
        } else if(gamesB > gamesA){
            r.B.forEach(p=>players[p].tennis.win++);
        }
    }

    // Update the appropriate round counter
    if(mode==="americano"){
        americanoRound = (americanoRound+1) % rounds.length;
        americanoState = {scoreA: 0, scoreB: 0};
    } else {
        tennisRound = (tennisRound+1) % rounds.length;
        tennisState = {tennisA: 0, tennisB: 0, gamesA: 0, gamesB: 0};
    }

    scoreA = scoreB = 0;
    tennisA = tennisB = 0;
    gamesA = gamesB = 0;

    // Clear action history after match finishes
    actionHistory = [];
    updateUndoButton();

    saveData();
    loadRound();
    updateScoreUI();
    updateRanking();
    
    // Show feedback
    showFeedback("Match finished! ‚úÖ");
    
    // Haptic feedback
    if(navigator.vibrate){
        navigator.vibrate([50, 50, 50]);
    }
}

// ===== RANKING =====

function updateRanking(){

    // Americano Ranking
    let americanoArr = Object.keys(players).map(name=>{
        return {
            name:name,
            win:players[name].americano.win,
            point:players[name].americano.point,
            conceded:players[name].americano.conceded,
            gap:players[name].americano.point - players[name].americano.conceded
        }
    });

    americanoArr.sort((a,b)=>{
        if(b.win !== a.win) return b.win - a.win;
        return b.gap - a.gap;
    });

    let americanoHtml="";
    americanoArr.forEach((p,i)=>{
        let rankClass = "";
        if(i===0) rankClass = "gold";
        else if(i===1) rankClass = "silver";
        else if(i===2) rankClass = "bronze";
        else if(i===3) rankClass = "fourth";

        americanoHtml += `
        <tr>
        <td class="${rankClass}">${i+1}</td>
        <td>${p.name}</td>
        <td>${p.win}</td>
        <td>${p.point}</td>
        <td>${p.conceded}</td>
        <td>${p.gap}</td>
        </tr>`;
    });

    document.getElementById("americanoRankingBody").innerHTML = americanoHtml;

    // Tennis Ranking
    let tennisArr = Object.keys(players).map(name=>{
        return {
            name:name,
            win:players[name].tennis.win,
            point:players[name].tennis.point,
            conceded:players[name].tennis.conceded,
            gap:players[name].tennis.point - players[name].tennis.conceded
        }
    });

    tennisArr.sort((a,b)=>{
        if(b.win !== a.win) return b.win - a.win;
        return b.gap - a.gap;
    });

    let tennisHtml="";
    tennisArr.forEach((p,i)=>{
        let rankClass = "";
        if(i===0) rankClass = "gold";
        else if(i===1) rankClass = "silver";
        else if(i===2) rankClass = "bronze";
        else if(i===3) rankClass = "fourth";

        tennisHtml += `
        <tr>
        <td class="${rankClass}">${i+1}</td>
        <td>${p.name}</td>
        <td>${p.win}</td>
        <td>${p.point}</td>
        <td>${p.conceded}</td>
        <td>${p.gap}</td>
        </tr>`;
    });

    document.getElementById("tennisRankingBody").innerHTML = tennisHtml;
}

// ===== HISTORY =====

function updateHistory(){
    // Americano History
    let americanoMatches = matchHistory.filter(m => m.mode === "americano");
    let americanoHtml = "";
    americanoMatches.forEach((m, i) => {
        let rankClass = "";
        if(i===0) rankClass = "gold";
        else if(i===1) rankClass = "silver";
        else if(i===2) rankClass = "bronze";
        else if(i===3) rankClass = "fourth";

        americanoHtml += `
        <tr>
        <td class="${rankClass}">${m.round}</td>
        <td>${m.teamA}</td>
        <td>${m.scoreA} - ${m.scoreB}</td>
        <td>${m.teamB}</td>
        <td class="${m.winner === m.teamA ? 'gold' : ''}">${m.winner}</td>
        </tr>`;
    });
    if(americanoMatches.length === 0){
        americanoHtml = "<tr><td colspan='5'>No matches played yet</td></tr>";
    }
    document.getElementById("americanoHistoryBody").innerHTML = americanoHtml;

    // Tennis History
    let tennisMatches = matchHistory.filter(m => m.mode === "tennis");
    let tennisHtml = "";
    tennisMatches.forEach((m, i) => {
        let rankClass = "";
        if(i===0) rankClass = "gold";
        else if(i===1) rankClass = "silver";
        else if(i===2) rankClass = "bronze";
        else if(i===3) rankClass = "fourth";

        tennisHtml += `
        <tr>
        <td class="${rankClass}">${m.round}</td>
        <td>${m.teamA}</td>
        <td>${m.scoreA} - ${m.scoreB}</td>
        <td>${m.teamB}</td>
        <td class="${m.winner === m.teamA ? 'gold' : ''}">${m.winner}</td>
        </tr>`;
    });
    if(tennisMatches.length === 0){
        tennisHtml = "<tr><td colspan='5'>No matches played yet</td></tr>";
    }
    document.getElementById("tennisHistoryBody").innerHTML = tennisHtml;
}

function finishTournament(){
    showTab('ranking');
}

function resetTournament(){
    localStorage.removeItem("padelPlayers");
    localStorage.removeItem("padelAmericanoRound");
    localStorage.removeItem("padelTennisRound");
    localStorage.removeItem("padelMatchHistory");
    localStorage.removeItem("padelAmericanoState");
    localStorage.removeItem("padelTennisState");
    localStorage.removeItem("padelCurrentMode");
    location.reload();
}

// Initialize state based on mode
if(mode==="americano"){
    currentRound = americanoRound;
    scoreA = americanoState.scoreA;
    scoreB = americanoState.scoreB;
    document.getElementById("btnAmericano").classList.add("active");
    document.getElementById("btnTennis").classList.remove("active");
} else {
    currentRound = tennisRound;
    tennisA = tennisState.tennisA;
    tennisB = tennisState.tennisB;
    gamesA = tennisState.gamesA;
    gamesB = tennisState.gamesB;
    document.getElementById("btnAmericano").classList.remove("active");
    document.getElementById("btnTennis").classList.add("active");
}

loadRound();
updateScoreUI();
updateRanking();
showRankingTab('americano');
showHistoryTab('americano');

// Set correct mode label
document.getElementById("modeLabel").innerText =
    mode==="americano" ? "Mode: Americano (Total Points: 21)" : "Mode: Tennis (Best of 3 Games)";

</script>
</body>
</html>
